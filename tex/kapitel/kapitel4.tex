\chapter{Konzeption}
\label{Kap4}

\section{Lokale Datenspeicherung}
Moderne Webbrowser stellen viele verschiedene Lösungen zum lokalen Speichern von Daten zu Verfügung. In diesem Kapitel werden einige davon mit ihren Stärken und Schwächen vorgestellt. Zuletzt wird eine passende Lösung für CROSSLOAD ausgewählt und begründet.

\subsection{Web Storage}
Der Web Storage besitzt zwei unterschiedliche Arten Daten zu speichern: LocalStorage und SessionStorage \autocite{Hajian2019} \autocite{mdn-web-storage}. Die beiden Speicher unterscheiden sich nur in der Dauer der Speicherung der Daten. Die Daten vom SessionStorage werden gelöscht sobald die Sitzung auf der Website vorbei ist, das heißt der Browser oder der Tab geschlossen wird \autocite{Hajian2019} \autocite{mdn-web-storage}. Der LocalStorage bleibt über mehrere Sitzungen erhalten und wird nicht automatisch gelöscht \autocite{Hajian2019} \autocite{mdn-web-storage}. 

Die Web Storage \ac{API} bietet die Möglichkeit Schlüssel / Wert Paare im Browser abzulegen \autocite{mdn-web-storage}. Alle relevanten Browser implementieren diese \ac{API} \autocite{mdn-web-storage}, es gibt aber auch einige Einschränkungen:

\begin{itemize}
	\item Zugriffe sind nur synchron möglich \autocite{Hajian2019}
	\item Als Schlüssel und Werte können jeweiles nur Strings gespeichert werden \autocite{Hajian2019}
	\item Die \ac{API} ist nicht von Web Workern aufrufbar \autocite{Hajian2019}. Service Worker haben zum Beispiel keinen Zugriff darauf
	\item Es können maximal 5 \ac{MB} an Daten gespeichert werden \autocite{mdn-web-storage}
\end{itemize}

Aufgrund der synchronität und des geringen Datenvolumes das gespeichert werden darf, eignet sich die Web Storage \ac{API} nur zum Speichern von wenig Daten. Größere Daten und insbesondere binäre Dateien, die nicht sehr gut in eine textuelle Form übertragen werden können sollten nicht abgespeichert werden. 

\subsection{WebSQL}

Asynchron (callback-based)
Nachteil: kein Web Worker Support, nicht in Firefox und depracated
\autocite{Hajian2019}

\subsection{File System API}

Asynchron (callback-based), bietet ein virtuelles Dateisystem zum ablegen von Daten. Läuft aber in einer Sandbox und kann nicht auf das "richtige" Dateisystem zugreifen.
Vorteil: funktioniert in Web Workers 
Nachteil: (Fast) nur von Chrome unterstützt
\autocite{Hajian2019}

\subsection{Indexed DB}

- Umfangreiche Objektdatenbank um große Datenmengen auf dem Client zu speichern. Unterstützt Indexe zum Durchsuchen. Unterstützt auch Transaktionen \autocite{Sheppard2017} 

- key-value pari NoSQL Datenbank zum Speichern von vielen Daten (bis zu 20-50 \% des verfügbaren Speicherplatzes). Unterstützt viele Datentypen, ist asynchron und kann überall verwendet werden \autocite{Hajian2019}

- Verfügbare Bibliotheken: LocalForage, Dexie.js, ... \autocite{Hajian2019}

Transaktionelle Datenbank
- Gut für viel Daten, die Durchsucht werden müssen
- Asynchron

\subsection{Cache API}

- Service Worker: Laufen im Hintergrund (im eigenen Thread) ohne Zugriff aufs DOM \autocite{Sheppard2017}

- Service Worker ist ein Mittler zwischen APP und Internet. Es übernimmt Aufgaben wie Caching, Syncing, Benachrichtigungen \autocite{Sheppard2017}

Service Worker:
- "Arbeiter" in JavaScript die im Hintergrund laufen
- Ermöglicht es Netzwerk-Request zu unterbrechen (Proxy)
- Benachrichtigungen zu senden
- Cache Verwalten und vieles mehr
- Laufen im eigenen Thread ohne DOM Zugriff, HTTPS-Only
- Website sollte nicht auf Service Worker angewiesen sein
\autocite{Hajian2019}

Angular bietet einen einfachen Weg Service Workers zu verwenden:
- ng add @angular/pwa
\autocite{Hajian2019}

Cache Strategien:
- Cache only: Es wird nur der Inhalt des Caches geliefert. Wenn nicht verfügbar wird nichts geliefert
- Netzwerk only: Es wird nur die Antwort des Requests gesendet
- Cache-First: Cache und wenn nicht verfügbar -> Netzwerk
- Netzwerk-First: Netzwerk und wenn nicht verfügbar -> Cache
- Cache und Netzwerk (stale-while-revalidate): Nimm erst den Wert vom Cache und sobald das Netzwerk geantwortet hat, die Antwort vom Netzwerk. Gut für sich häufig ändernde Daten (Facebook)
- Generic-Fallback: Zum Beispiel für ein Bild ein Standardbild liefern, wenn Netzwerk und Cache keins haben
\autocite{Hajian2019} \autocite{Rojas2020}

Bibliothek für Service Worker:
- Workbox
\autocite{Rojas2020}

Cache storage != browser cache \autocite{Rojas2020}

\subsection{Überblick und Entscheidung}
In Tabelle~\ref{Kap4:Datenspeicherung} werden die vorgestellten Möglichkeiten zum Speichern von Daten nach folgenden Kriterien verglichen: maximale Datenmenge, mögliche Datentypen, synchron / asynchron, Browsersupport, in Web Worker aufrufbar.

\begin{table}[h]
  \caption{Vergleich der APIs zur lokalen Datenspeicherung}
  \label{Kap4:Datenspeicherung}
  \renewcommand{\arraystretch}{1.2}
  \centering
  \sffamily
  \begin{footnotesize}
    \begin{tabularx}{1.0\textwidth}{l l l l l l}
      \toprule
      \textbf{Technologie} & \textbf{Datenmenge} & \textbf{Datentypen} & \textbf{(a)synchron} & \textbf{Browsersupport} & \textbf{Web Worker} \\
      \midrule
      \emph{Web Storage \ac{API}} & max. 5 \ac{MB} & String & nur synchron & alle & nein \\
      \emph{Web SQL} &  &  &  &  &  \\
      \emph{File System \ac{API}} &  &  &  &  &  \\
      \emph{Indexed DB} &  &  &  &  &  \\
      \emph{Cache \ac{API}} &  &  &  &  &  \\
      \bottomrule
    \end{tabularx}
  \end{footnotesize}
  \rmfamily
\end{table}

\section{Herunterladen der Audiodaten}

\subsection{Fetch API}

Einfachere XMLHttpRequests, Promise basierend
\autocite{Rojas2020}

\subsection{Background Fetch}

\subsection{Background Sync}

- Speichert den API Call bis eine stabile Internetverbindung besteht und schickt ihn dann raus. Sogar wenn die APP nicht aktiv ist oder läuft \autocite{Sheppard2017}

- Versendet Request sobald eine Internetverbindung besteht, auch wenn die APP nicht offen ist \autocite{Rojas2020}

- Man kann diese API mit IndexedDB kombinieren. Daten können in der Datenbank zwischengespeichert werden, bis eine Verbindung besteht \autocite{Rojas2020}

\section{Verbindungsstaus auslesen}

- navigator.onLine: ist nicht 100\% genau. Wird manchmal sagen, dass das Gerät online ist wenn es nur mit einem Netzwerk verbunden ist \autocite{Sheppard2017}


